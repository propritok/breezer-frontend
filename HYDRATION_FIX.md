# Исправление ошибок гидратации в Next.js

## Проблема

Ошибка "Hydration failed because the initial UI does not match what was rendered on the server" возникает, когда HTML, сгенерированный на сервере, не совпадает с тем, что рендерится на клиенте.

## Найденные и исправленные проблемы

### 1. Конфликт провайдеров тем

**Проблема**: У вас было несколько провайдеров тем с разными настройками:

- `src/pages/_app.tsx`: `defaultTheme='light'`
- `src/app/providers.tsx`: `defaultTheme='dark'` (удален)
- `src/app/App.tsx`: `defaultTheme='light'` (удален)

**Решение**:

- Удалены дублирующиеся файлы провайдеров
- В `src/pages/_app.tsx` добавлены параметры для предотвращения ошибок гидратации:
  ```tsx
  <NextThemesProvider
    attribute='class'
    defaultTheme='light'
    enableSystem={false}
    disableTransitionOnChange>
    <div suppressHydrationWarning>{/* контент */}</div>
  </NextThemesProvider>
  ```

### 2. Компоненты с динамическим состоянием

**Проблема**: Компоненты, использующие `useState`, `useRouter` и другие хуки, могут рендериться по-разному на сервере и клиенте.

**Исправленные компоненты**:

- `SiteBreadcrumbs` - добавлена проверка `mounted`
- `ProductGallery` - добавлена проверка `mounted` и кнопки в статичной версии
- `Newsletter` - добавлена проверка `mounted`
- `ContactForm` - добавлена проверка `mounted`
- `Calculator` - добавлена проверка `mounted`
- `ProductSearch` - добавлена проверка `mounted`
- `OrderForm` - добавлена проверка `mounted`
- `SpecsTable` - добавлена проверка `mounted` и кнопка в статичной версии
- `ContactCTAButton` - добавлена проверка `mounted`
- `ContactFormCTA` - добавлена проверка `mounted`
- `PhoneInput` - добавлена проверка `mounted`
- `catalog/[id].tsx` - добавлена проверка `mounted`

### 3. Страницы с динамическими данными

**Проблема**: Страницы, использующие `useRouter` для получения параметров, могут иметь проблемы с гидратацией.

**Решение**: Добавлена проверка `mounted` и показ состояния загрузки до полной гидратации.

### 4. Проблемы с кнопками и интерактивными элементами

**Проблема**: Кнопки с `onClick` обработчиками и другие интерактивные элементы могут отсутствовать в серверном HTML, но присутствовать в клиентском.

**Решение**:

- Добавлены кнопки в статичные версии компонентов без обработчиков событий
- Использованы `disabled` состояния для неактивных элементов
- Обеспечено соответствие HTML структуры между сервером и клиентом

## Паттерн исправления

Для каждого компонента с динамическим состоянием используется следующий паттерн:

```tsx
import React, { useState, useEffect } from 'react';

const Component: React.FC = () => {
  const [mounted, setMounted] = useState(false);

  useEffect(() => {
    setMounted(true);
  }, []);

  // Не рендерим интерактивные элементы на сервере
  if (!mounted) {
    return (
      // Статичная версия компонента без интерактивности
      // Включает все элементы, но без обработчиков событий
    );
  }

  return (
    // Полная версия компонента с интерактивностью
  );
};
```

## Утилиты

Созданы утилиты для упрощения работы с гидратацией:

```tsx
// src/shared/lib/utils.ts
export const useIsMounted = () => {
  const [mounted, setMounted] = React.useState(false);
  React.useEffect(() => {
    setMounted(true);
  }, []);
  return mounted;
};
```

## Рекомендации

1. **Всегда проверяйте клиентский рендеринг** для компонентов с:

   - `useState`
   - `useRouter`
   - `useEffect`
   - Формами
   - Интерактивными элементами
   - `onClick` обработчиками

2. **Используйте `suppressHydrationWarning`** только для провайдеров тем и других случаев, когда несоответствие ожидаемо.

3. **Показывайте состояние загрузки** для страниц с динамическими данными.

4. **Избегайте дублирования провайдеров** - используйте только один набор провайдеров в `_app.tsx`.

5. **Обеспечивайте соответствие HTML структуры** - если элемент есть в клиентской версии, он должен быть и в серверной (даже если неактивен).

## Результат

После внесения этих изменений ошибки гидратации должны быть устранены, и приложение будет корректно работать как на сервере, так и на клиенте.
